---
title: "Monotone TDLNM"
author: "Daniel Mork, Harvard T.H. Chan School of Public Health"
date: 'Nov. 1, 2022'
output:
  html_document:
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(dlnm)
library(mgcv)
#### Use to install dlmtree package ####
# library(devtools)
# install_github("daniel_mork/dlmtree", ref = "mono_var_select_logit")
library(dlmtree)
library(data.table)
library(ggplot2)

# Function to combine multiple MCMC runs
restarts <- 10
combine_models <- function(mlist) {
  out <- mlist[[1]]
  iter <- out$mcmcIter
  out$DLM <- do.call(rbind, lapply(1:length(mlist), function(i) {
    d <- mlist[[i]]$DLM
    d$Iter <- d$Iter + (i - 1) * iter
    d
  }))
  out$mcmcIter <- mlist[[1]]$mcmcIter * length(mlist)
  out$nIter <- mlist[[1]]$nIter * length(mlist)
  colnames(out$DLM) <- colnames(mlist[[1]]$DLM)
  out$sigma2 <- do.call(c, lapply(mlist, function(l) l$sigma2))
  out$kappa <- do.call(c, lapply(mlist, function(l) l$kappa))
  out$nu <- do.call(c, lapply(mlist, function(l) l$nu))
  out$tau <- do.call(rbind, lapply(mlist, function(l) l$tau))
  out$termNodes <- do.call(rbind, lapply(mlist, function(l) l$termNodes))
  out$gamma <- do.call(rbind, lapply(mlist, function(l) l$gamma))
  out$zirt <- do.call(rbind, lapply(mlist, function(l) l$zirt))
  out$zirtCov <- do.call(rbind, lapply(mlist, function(l) l$zirtCov))
  out$timeProbs <- do.call(rbind, lapply(mlist, function(l) l$timeProbs))
  out$timeCounts <- do.call(rbind, lapply(mlist, function(l) l$timeCounts))
  out$sigma2 <- do.call(c, lapply(mlist, function(l) l$sigma2))
  return(out)
}
out_trans <- function(x) 100*(exp(x) - 1)
set.seed(19283)
```


## Create lagged data
We create a lagged dataset with current exposures and exposures from 20 days prior. We differentiate the dataset to model summer (May-Sept) and winter (Oct-Apr) separately because very cold and very warm temperatures are expected to both have detrimental effects on health and we wish to model a monotone effect.

As death counts are large, we assume deaths to be a continuous variable and use a standard linear model framework. We control for time using an interaction between year and month as well as day of week. We compare three methods: monotone TDLNM, standard TDLNM, and penalized spline DLNM.

```{r data}
data("chicagoNMMAPS")
setDT(chicagoNMMAPS)
lags <- 20
chicagoNMMAPS[, paste0("temp.", 0:lags) := shift(temp, 0:lags, type = "lag")]
cols <- c("death", "month", "year", "dow", paste0("temp.", 0:lags))
data <- chicagoNMMAPS[complete.cases(chicagoNMMAPS[, ..cols])]
data$logdeath <- log(data$death)
hist(data$logdeath, xlab = "Log daily deaths", main = "")
summer_data <- data[month > 4 & month < 10]
winter_data <- data[month < 5 | month > 9]
cols <- paste0("temp.", 0:lags)
summer_temp_dat <- as.matrix(summer_data[, ..cols])
temp_splits <- seq(min(summer_temp_dat), max(summer_temp_dat), length.out = 20)
winter_temp_dat <- -as.matrix(winter_data[, ..cols])
w_temp_splits <- seq(min(winter_temp_dat), max(winter_temp_dat), length.out = 20)
# N days: summer
summer_data[,.N]
# Range of lagged temperatures: summer
round(range(summer_temp_dat), 2)
# N days: winter
winter_data[,.N]
# Range of lagged temperatures: winter
round(range(winter_temp_dat), 2)
```

## Summer model
Run all models on summer mortality/temperature data. We use 3 models: monotone TDLNM, TDLNM, and penalized spline DLNM (psDLNM). Control for month:year indicator and day of week to adjust for time trends in mortality.
### Monotone TDLNM
```{r summer tdlnm monotone, cache=TRUE}
gamma_prior <- rep(0.25, lags + 1)
gamma_prior[1:5] <- 0.75
split_prior <- rep(1, lags)
split_prior[1:6] <- 10
mlist <- list()
for (m in 1:restarts) {
  cat(".")
  mlist[[m]] <- tdlnm(logdeath ~ as.factor(year) * as.factor(month) + as.factor(dow),
                      data = summer_data,
                      exposure.data = summer_temp_dat, 
                      exposure.splits = temp_splits,
                      n.trees = 20, n.burn = 2000, n.iter = 5000, n.thin = 10,
                      monotone = TRUE, zirt.p0 = gamma_prior, zirt.p0.strength = 2,
                      tree.time.split.params = split_prior, verbose = F)
}
summer_deaths <- combine_models(mlist)
s_summer_deaths <- summary(summer_deaths, cenval = 20, pred.at = 10:32)
s_summer_deaths$matfit <- out_trans(s_summer_deaths$matfit)
s_summer_deaths$cilower <- out_trans(s_summer_deaths$cilower)
s_summer_deaths$ciupper <- out_trans(s_summer_deaths$ciupper)
```

### Standard TDLNM
```{r summer tdlnm, cache=TRUE}
split_prior <- rep(1, lags)
split_prior[1:6] <- 10
for (m in 1:restarts) {
  cat(".")
  mlist[[m]] <- tdlnm(logdeath ~ as.factor(year) * as.factor(month) + as.factor(dow),
                      data = summer_data,
                      exposure.data = summer_temp_dat, 
                      exposure.splits = temp_splits,
                      n.trees = 20, n.burn = 2000, n.iter = 5000, n.thin = 10,
                      tree.time.split.params = split_prior,
                      verbose = F)
}
summer_deaths2 <- combine_models(mlist)
s_summer_deaths2 <- summary(summer_deaths2, cenval = 20, pred.at = 10:32)
s_summer_deaths2$matfit <- out_trans(s_summer_deaths2$matfit)
s_summer_deaths2$cilower <- out_trans(s_summer_deaths2$cilower)
s_summer_deaths2$ciupper <- out_trans(s_summer_deaths2$ciupper)
```

### Penalized spline DLNM
```{r summer dlnm, cache=TRUE}
cb <- crossbasis(summer_temp_dat, lag = c(0, lags),
                 argvar = list(fun = "ps", df = 10), 
                 arglag = list(fun = "ps", intercept = T, df = 10))
pen <- cbPen(cb, addSlag = rep(0:1, c(3, 7)))
summer_deaths_gam <- gam(logdeath ~ cb + as.factor(year) * as.factor(month) + as.factor(dow),
                         data = summer_data, paraPen = list(cb = pen))
cp_summer <- crosspred(cb, summer_deaths_gam, at = 10:32, bylag = 1, cen = 20)
cp_summer$matfit <- out_trans(cp_summer$matfit)
cp_summer$matlow <- out_trans(cp_summer$matlow)
cp_summer$mathigh <- out_trans(cp_summer$mathigh)
```

### Lag days of susceptibility
We report periods of identified susceptiblity to temperature. For monotone-TDLNM, we use the posterior inference for probability of effect at each lag. For TDLNM and psDLNM we use periods where the credible intervals do not contain zero at any temperature level. This implies a relationship between temperature and mortality when contrasted with a temperature of 20 degrees C.
```{r summer susceptible days}
# Monotone TDLNM
plot(0:lags, s_summer_deaths$splitProb, main = "Monotone-TDLNM: Posterior inference", type = 'l', xlab = "Lag", ylab = "Prob of effect", ylim = c(0, 1)); abline(h = 0.95, col = "red", lty = 2)
(0:20)[s_summer_deaths$splitProb >= 0.95]
# TDLNM
(0:20)[which(colSums(s_summer_deaths2$cilower > 0 | s_summer_deaths2$ciupper < 0) > 0)]
# pSDLNM
(0:20)[which(colSums(cp_summer$matlow > 0 | cp_summer$mathigh < 0) > 0)]
```


As before, we show the time periods and temperatures where there is a nonzero relationship between temperature and mortality. Blue indicates temperatures of increased mortality while red indicates temperatures with decreased mortality. 
```{r effect summer}
plot(s_summer_deaths, plot.type = "effect", main = "Monotone-TDLNM", start.time = 0, ylab = "Temperature (degrees C)", xlab = "Lag (days)")
plot(s_summer_deaths2, plot.type = "effect", main = "TDLNM", start.time = 0, ylab = "Temperature (degrees C)", xlab = "Lag (days)")
filled.contour(0:20, cp_summer$predvar, t((cp_summer$matlow>0) - (cp_summer$mathigh<0)),
               xlab = "Lag (days)", ylab = "Temperature (degrees C)", 
               main = "psDLNM", levels = c(-1, -.1, .1, 1),
               col = c("red", "white", "blue"))
```


### Temperature slices of estimated exposure-lag-response function
```{r summer plots}
plot_dat <- rbind.data.frame(
  data.frame(lag = 0:lags, 
             y = s_summer_deaths$matfit["22",],
             ymin = s_summer_deaths$cilower["22",],
             ymax = s_summer_deaths$ciupper["22",],
             grp = "22 deg C",
             model = "Monotone-TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_summer_deaths$matfit["28",],
             ymin = s_summer_deaths$cilower["28",],
             ymax = s_summer_deaths$ciupper["28",],
             grp = "28 deg C",
             model = "Monotone-TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_summer_deaths$matfit["32",],
             ymin = s_summer_deaths$cilower["32",],
             ymax = s_summer_deaths$ciupper["32",],
             grp = "32 deg C",
             model = "Monotone-TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_summer_deaths2$matfit["22",],
             ymin = s_summer_deaths2$cilower["22",],
             ymax = s_summer_deaths2$ciupper["22",],
             grp = "22 deg C",
             model = "TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_summer_deaths2$matfit["28",],
             ymin = s_summer_deaths2$cilower["28",],
             ymax = s_summer_deaths2$ciupper["28",],
             grp = "28 deg C",
             model = "TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_summer_deaths2$matfit["32",],
             ymin = s_summer_deaths2$cilower["32",],
             ymax = s_summer_deaths2$ciupper["32",],
             grp = "32 deg C",
             model = "TDLNM"),
  data.frame(lag = 0:lags, 
             y = cp_summer$matfit["22",],
             ymin = cp_summer$matlow["22",],
             ymax = cp_summer$mathigh["22",],
             grp = "22 deg C",
             model = "psDLNM"),
  data.frame(lag = 0:lags, 
             y = cp_summer$matfit["28",],
             ymin = cp_summer$matlow["28",],
             ymax = cp_summer$mathigh["28",],
             grp = "28 deg C",
             model = "psDLNM"),
  data.frame(lag = 0:lags, 
             y = cp_summer$matfit["32",],
             ymin = cp_summer$matlow["32",],
             ymax = cp_summer$mathigh["32",],
             grp = "32 deg C",
             model = "psDLNM")
)
plot_dat$model <- factor(plot_dat$model, levels = c("psDLNM", "TDLNM","Monotone-TDLNM"))
ggplot(plot_dat, aes(x = lag, y = y, ymin = ymin, ymax = ymax)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_ribbon(fill = "grey") +
  geom_line(size = 1) +
  facet_grid(grp~model) +
  theme_bw(base_size = 16) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Lag (days)", y = "% Difference in Mortality")
```

### Lag slices of estimated exposure-lag-response function
```{r summer plots2}
plot_dat <- rbind.data.frame(
  data.frame(temp = s_summer_deaths$pred.at, 
             y = s_summer_deaths$matfit[,2],
             ymin = s_summer_deaths$cilower[,2],
             ymax = s_summer_deaths$ciupper[,2],
             grp = "1 day prior",
             model = "Monotone-TDLNM"),
  data.frame(temp = s_summer_deaths$pred.at, 
             y = s_summer_deaths$matfit[,3],
             ymin = s_summer_deaths$cilower[,3],
             ymax = s_summer_deaths$ciupper[,3],
             grp = "2 days prior",
             model = "Monotone-TDLNM"),
  data.frame(temp = s_summer_deaths$pred.at, 
             y = s_summer_deaths$matfit[,6],
             ymin = s_summer_deaths$cilower[,6],
             ymax = s_summer_deaths$ciupper[,6],
             grp = "5 days prior",
             model = "Monotone-TDLNM"),
  data.frame(temp = s_summer_deaths2$pred.at, 
             y = s_summer_deaths2$matfit[,2],
             ymin = s_summer_deaths2$cilower[,2],
             ymax = s_summer_deaths2$ciupper[,2],
             grp = "1 day prior",
             model = "TDLNM"),
  data.frame(temp = s_summer_deaths2$pred.at, 
             y = s_summer_deaths2$matfit[,3],
             ymin = s_summer_deaths2$cilower[,3],
             ymax = s_summer_deaths2$ciupper[,3],
             grp = "2 days prior",
             model = "TDLNM"),
  data.frame(temp = s_summer_deaths2$pred.at, 
             y = s_summer_deaths2$matfit[,6],
             ymin = s_summer_deaths2$cilower[,6],
             ymax = s_summer_deaths2$ciupper[,6],
             grp = "5 days prior",
             model = "TDLNM"),
  data.frame(temp = cp_summer$predvar, 
             y = cp_summer$matfit[,2],
             ymin = cp_summer$matlow[,2],
             ymax = cp_summer$mathigh[,2],
             grp = "1 day prior",
             model = "psDLNM"),
  data.frame(temp = cp_summer$predvar, 
             y = cp_summer$matfit[,3],
             ymin = cp_summer$matlow[,3],
             ymax = cp_summer$mathigh[,3],
             grp = "2 days prior",
             model = "psDLNM"),
  data.frame(temp = cp_summer$predvar, 
             y = cp_summer$matfit[,6],
             ymin = cp_summer$matlow[,6],
             ymax = cp_summer$mathigh[,6],
             grp = "5 days prior",
             model = "psDLNM")
)
plot_dat$model <- factor(plot_dat$model, levels = c("psDLNM", "TDLNM","Monotone-TDLNM"))
ggplot(plot_dat, aes(x = temp, y = y, ymin = ymin, ymax = ymax)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_ribbon(fill = "grey") +
  geom_line(size = 1) +
  facet_grid(grp~model) +
  theme_bw(base_size = 16) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Temperature", y = "% Difference in Mortality")
```




## Winter model
We repeat the temperature-mortality model for winter days (October through April). We reverse the temperature axis to maintain monotone increasing for the monotone-TDLNM approach. All temperatures are represented as degrees below zero, where negative temperatures indicate degrees above zero.
### Monotone TDLNM
```{r winter tdlnm monotone, cache=TRUE}
gamma_prior <- rep(0.25, lags + 1)
gamma_prior[1:10] <- 0.75
split_prior <- rep(1, lags)
split_prior[1:11] <- 10
for (m in 1:restarts) {
  cat(".")
  mlist[[m]] <- tdlnm(logdeath ~ as.factor(year) * as.factor(month) + as.factor(dow),
                      data = winter_data,
                      exposure.data = winter_temp_dat, 
                      exposure.splits = w_temp_splits,
                      n.trees = 20, n.burn = 2000, n.iter = 5000, n.thin = 10,
                      monotone = TRUE, zirt.p0 = gamma_prior, zirt.p0.strength = 1,
                      tree.time.split.params = split_prior, verbose = F)
}
winter_deaths <- combine_models(mlist)
s_winter_deaths <- summary(winter_deaths, cenval = -20, pred.at = -20:20)
s_winter_deaths$matfit <- out_trans(s_winter_deaths$matfit)
s_winter_deaths$cilower <- out_trans(s_winter_deaths$cilower)
s_winter_deaths$ciupper <- out_trans(s_winter_deaths$ciupper)
```

### Standard TDLNM
```{r winter tdlnm, cache=TRUE}
split_prior <- rep(1, lags)
split_prior[1:11] <- 10
for (m in 1:restarts) {
  cat(".")
  mlist[[m]] <- tdlnm(logdeath ~ as.factor(year) * as.factor(month) + as.factor(dow),
                      data = winter_data,
                      exposure.data = winter_temp_dat, 
                      exposure.splits = w_temp_splits,
                      n.trees = 20, n.burn = 2000, n.iter = 5000, n.thin = 10,
                      tree.time.split.params = split_prior,
                      verbose = F)
}
winter_deaths2 <- combine_models(mlist)
s_winter_deaths2 <- summary(winter_deaths2, cenval = -20, pred.at = -20:20)
s_winter_deaths2$matfit <- out_trans(s_winter_deaths2$matfit)
s_winter_deaths2$cilower <- out_trans(s_winter_deaths2$cilower)
s_winter_deaths2$ciupper <- out_trans(s_winter_deaths2$ciupper)
```

### Penalized spline DLNM
```{r winter dlnm, cache=TRUE}
cb <- crossbasis(winter_temp_dat, lag = c(0, lags),
                 argvar = list(fun = "ps", df = 10), 
                 arglag = list(fun = "ps", intercept = T, df = 10))
pen <- cbPen(cb, addSlag = rep(0:1, c(5, 5)))
winter_deaths_gam <- gam(logdeath ~ cb + as.factor(year) * as.factor(month) + as.factor(dow),
                         data = winter_data, paraPen = list(cb = pen))
cp_winter <- crosspred(cb, winter_deaths_gam, at = -20:20, bylag = 1, cen = -20)
cp_winter$matfit <- out_trans(cp_winter$matfit)
cp_winter$matlow <- out_trans(cp_winter$matlow)
cp_winter$mathigh <- out_trans(cp_winter$mathigh)
```

### Lag days of susceptibility
```{r winter susceptible days}
# Monotone-TDLNM
plot(0:lags, s_winter_deaths$splitProb, main = "Monotone-TDLNM: Posterior inference", type = 'l', xlab = "Lag", ylab = "Prob of effect", ylim = c(0, 1)); abline(h = 0.95, col = "red", lty = 2)
(0:20)[s_winter_deaths$splitProb >= 0.95]
# TDLNM
(0:20)[which(colSums(s_winter_deaths2$cilower > 0 | s_winter_deaths2$ciupper < 0) > 0)]
# psDLNM
(0:20)[which(colSums(cp_winter$matlow > 0 | cp_winter$mathigh < 0) > 0)]
```

```{r effect winter}
plot(s_winter_deaths, plot.type = "effect", main = "Monotone-TDLNM", start.time = 0, ylab = "Temperature (degrees below C)", xlab = "Lag (days)")
plot(s_winter_deaths2, plot.type = "effect", main = "TDLNM", start.time = 0, ylab = "Temperature (degrees below C)", xlab = "Lag (days)")
filled.contour(0:20, cp_winter$predvar, t((cp_winter$matlow>0) - (cp_winter$mathigh<0)),
               xlab = "Lag (days)", ylab = "Temperature (degrees below C)", 
               main = "psDLNM", levels = c(-1, -.1, .1, 1),
               col = c("red", "white", "blue"))
```

### Temperature slices of estimated exposure-lag-response function
```{r winter plots}
plot_dat <- rbind.data.frame(
  data.frame(lag = 0:lags, 
             y = s_winter_deaths$matfit["-10",],
             ymin = s_winter_deaths$cilower["-10",],
             ymax = s_winter_deaths$ciupper["-10",],
             grp = "10 deg C",
             model = "Monotone-TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_winter_deaths$matfit["0",],
             ymin = s_winter_deaths$cilower["0",],
             ymax = s_winter_deaths$ciupper["0",],
             grp = "0 deg C",
             model = "Monotone-TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_winter_deaths$matfit["15",],
             ymin = s_winter_deaths$cilower["15",],
             ymax = s_winter_deaths$ciupper["15",],
             grp = "-15 deg C",
             model = "Monotone-TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_winter_deaths2$matfit["-10",],
             ymin = s_winter_deaths2$cilower["-10",],
             ymax = s_winter_deaths2$ciupper["-10",],
             grp = "10 deg C",
             model = "TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_winter_deaths2$matfit["0",],
             ymin = s_winter_deaths2$cilower["0",],
             ymax = s_winter_deaths2$ciupper["0",],
             grp = "0 deg C",
             model = "TDLNM"),
  data.frame(lag = 0:lags, 
             y = s_winter_deaths2$matfit["15",],
             ymin = s_winter_deaths2$cilower["15",],
             ymax = s_winter_deaths2$ciupper["15",],
             grp = "-15 deg C",
             model = "TDLNM"),
  data.frame(lag = 0:lags, 
             y = cp_winter$matfit["-10",],
             ymin = cp_winter$matlow["-10",],
             ymax = cp_winter$mathigh["-10",],
             grp = "10 deg C",
             model = "psDLNM"),
  data.frame(lag = 0:lags, 
             y = cp_winter$matfit["0",],
             ymin = cp_winter$matlow["0",],
             ymax = cp_winter$mathigh["0",],
             grp = "0 deg C",
             model = "psDLNM"),
  data.frame(lag = 0:lags, 
             y = cp_winter$matfit["15",],
             ymin = cp_winter$matlow["15",],
             ymax = cp_winter$mathigh["15",],
             grp = "-15 deg C",
             model = "psDLNM")
)
plot_dat$model <- factor(plot_dat$model, levels = c("psDLNM", "TDLNM","Monotone-TDLNM"))
ggplot(plot_dat, aes(x = lag, y = y, ymin = ymin, ymax = ymax)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_ribbon(fill = "grey") +
  geom_line(size = 1) +
  facet_grid(grp~model) +
  theme_bw(base_size = 16) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Lag (days)", y = "% Difference in Mortality")
```


### Lag slices of estimated exposure-lag-response function
```{r winter plots2}
plot_dat <- rbind.data.frame(
  data.frame(temp = s_winter_deaths$pred.at, 
             y = s_winter_deaths$matfit[,2],
             ymin = s_winter_deaths$cilower[,2],
             ymax = s_winter_deaths$ciupper[,2],
             grp = "1 day prior",
             model = "Monotone-TDLNM"),
  data.frame(temp = s_winter_deaths$pred.at, 
             y = s_winter_deaths$matfit[,3],
             ymin = s_winter_deaths$cilower[,3],
             ymax = s_winter_deaths$ciupper[,3],
             grp = "2 days prior",
             model = "Monotone-TDLNM"),
  data.frame(temp = s_winter_deaths$pred.at, 
             y = s_winter_deaths$matfit[,6],
             ymin = s_winter_deaths$cilower[,6],
             ymax = s_winter_deaths$ciupper[,6],
             grp = "5 days prior",
             model = "Monotone-TDLNM"),
  data.frame(temp = s_winter_deaths2$pred.at, 
             y = s_winter_deaths2$matfit[,2],
             ymin = s_winter_deaths2$cilower[,2],
             ymax = s_winter_deaths2$ciupper[,2],
             grp = "1 day prior",
             model = "TDLNM"),
  data.frame(temp = s_winter_deaths2$pred.at, 
             y = s_winter_deaths2$matfit[,3],
             ymin = s_winter_deaths2$cilower[,3],
             ymax = s_winter_deaths2$ciupper[,3],
             grp = "2 days prior",
             model = "TDLNM"),
  data.frame(temp = s_winter_deaths2$pred.at, 
             y = s_winter_deaths2$matfit[,6],
             ymin = s_winter_deaths2$cilower[,6],
             ymax = s_winter_deaths2$ciupper[,6],
             grp = "5 days prior",
             model = "TDLNM"),
  data.frame(temp = cp_winter$predvar, 
             y = cp_winter$matfit[,2],
             ymin = cp_winter$matlow[,2],
             ymax = cp_winter$mathigh[,2],
             grp = "1 day prior",
             model = "psDLNM"),
  data.frame(temp = cp_winter$predvar, 
             y = cp_winter$matfit[,3],
             ymin = cp_winter$matlow[,3],
             ymax = cp_winter$mathigh[,3],
             grp = "2 days prior",
             model = "psDLNM"),
  data.frame(temp = cp_winter$predvar, 
             y = cp_winter$matfit[,6],
             ymin = cp_winter$matlow[,6],
             ymax = cp_winter$mathigh[,6],
             grp = "5 days prior",
             model = "psDLNM")
)
plot_dat$model <- factor(plot_dat$model, levels = c("psDLNM", "TDLNM","Monotone-TDLNM"))
ggplot(plot_dat, aes(x = temp, y = y, ymin = ymin, ymax = ymax)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_ribbon(fill = "grey") +
  geom_line(size = 1) +
  facet_grid(grp~model) +
  theme_bw(base_size = 16) +
  scale_x_continuous(expand = c(0, 0), limits = c(-19, 20)) +
  labs(x = "Degrees below zero", y = "% Difference in Mortality")
```

```{r prob effect, include=FALSE}
plot_dat_pe <- rbind.data.frame(
  data.frame(lag = 0:lags, prob = s_summer_deaths$splitProb, group = "Summer"),
  data.frame(lag = 0:lags, prob = s_winter_deaths$splitProb, group = "Winter")
)
ggplot(plot_dat_pe, aes(x = lag, y = prob, color = group, linetype = group)) +
  geom_hline(yintercept = 0.95, color = "black", linetype = 1, size = 1) +
  geom_line(size = 2) +
  theme_bw(base_size = 16) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "Lag (days)", y = "Probability of effect", color = "", linetype = "") +
  theme(legend.position = "bottom", legend.key.width = unit(1, "cm"))
```

